server {
    listen 8080;
    server_name localhost;

    # --- IP WHITELISTING LOGIC ---
    set $is_allowed 0;

    # Allow Abu Dhabi (IPv4 & IPv6) and Cairo (IPv4) IPs via Cloud Run Proxy
    if ($http_x_forwarded_for ~* "(5\.192\.130\.15|2001:4860:7:232::fe|156\.204\.219\.175|156\.213\.146\.94|41\.41\.16\.228|41\.41\.|197\.52\.197\.176)") {
        set $is_allowed 1;
    }
    
    # Allow local development and direct hits from whitelisted IPs
    if ($remote_addr ~* "(127\.0\.0\.1|::1|5\.192\.130\.15|2001:4860:7:232::fe|156\.204\.219\.175|156\.213\.146\.94|41\.41\.16\.228|41\.41\.|197\.52\.197\.176)") {
        set $is_allowed 1;
    }

    # Block all other traffic with a proper 403 page
    if ($is_allowed = 0) {
        return 403 "<html><head><title>403 Forbidden</title></head><body style='background:#121212;color:#eee;font-family:sans-serif;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;'><div><h1>403 Forbidden</h1><p>Access restricted to DEC Corporate Network.</p></div></body></html>";
        add_header Content-Type text/html;
    }
    # -----------------------------

    location /zoho-accounts/ {
        proxy_pass https://accounts.zoho.com/;
        proxy_set_header Host accounts.zoho.com;
        proxy_ssl_server_name on;
    }

    location /zoho-mail/ {
        proxy_pass https://mail.zoho.com/;
        proxy_set_header Host mail.zoho.com;
        proxy_ssl_server_name on;
    }

    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri $uri/ /index.html;
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
